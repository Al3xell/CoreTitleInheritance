# All scopes are titles unless otherwise noted.

is_title_core_due_to_capital = { # scope is title
    OR = {
            holder.capital_barony = this # capital barony
            AND = {
                holder.capital_barony.target_is_de_jure_liege_or_above = this # de_jure above capital barony
                this.tier < holder.primary_title.tier # not the same tier as the primary title
            }
        }
}

# Assume the default is false/no. Otherwise will need to modify.
is_title_core_due_to_cti = {
    if = {
        limit = {exists = var:core}
        AND = {
            var:core
            NOT = {
                AND = {
                    is_title_core_due_to_capital
                    holder.primary_title = this
                }# I believe that there should be no source always_follows_primary_heir except for during title creation. Titles with this flag cannot be designated core, so they should not have the variable core associated.
            }
        }
    }
}
# MUST BE CAREFUL THAT THE TRIGGERS ABOVE AND BELOW THIS AGREE!
#This catches primary titles and capitals as well (I assume)
# Assume the default is false/no. Otherwise will need to modify.
is_title_core = { # Assume that this will only be called if the title is owned
    if = {
        limit = {exists = var:core}
        OR = {
            var:core
            is_title_core_due_to_capital
            holder.primary_title = this
            always_follows_primary_heir
        }
    }
    else = {
        OR = {
            is_title_core_due_to_capital
            holder.primary_title = this
            always_follows_primary_heir
        }
    }
}

does_cti_core_title_have_cost = { # scope is title
    tier <= tier_county
}
# have both even though they are the same in case I want to break this equivalence in the future.
does_cti_core_title_count_to_limit = { # scope is title
    tier <= tier_county
}

is_title_eligible_for_core = { # Assume that this will only be called if the title is owned
    AND = {
        save_temporary_scope_as = this_title
        NOT = { is_title_core }
        OR = {
            tier <= tier_county
            holder.any_core_title = {
                this.de_jure_liege = scope:this_title
            } # this should mean that one of the core titles is a direct child of this title
        }
    }
}

# assumes that core title rules are being followed - only checks one tier up
will_core_loss_break_titles = {
    de_jure_liege = {save_temporary_scope_as = parent_title}
    save_temporary_scope_as = this_title
    OR = {
        scope:parent_title.is_title_core = no
        NOT = {this.holder.primary_title = scope:parent_title} # the primary title breaks the pattern for core titles.
        holder.any_core_title = {
            AND = {
                NOT = {this = scope:this_title}
                this.de_jure_liege = scope:parent_title
            }
        }
    }
}


is_core_consistent = {# scope is title
    save_temporary_scope_as = this_title
    OR = {
        tier <= tier_county
        holder.primary_title = this
        is_title_core_due_to_capital
        holder.any_core_title = {
            this.de_jure_liege = scope:this_title
        }
    }
}

# Assume the default is false/no. Otherwise will need to modify.
is_over_core_limit = { # scope is character
    trigger_if = {
        limit = {exists = this.var:core_count}
        this.var:core_count > this.core_limit
        }
}

can_core_title = {
    AND = {
        is_title_eligible_for_core
        holder.is_over_core_limit = no
    }
}

can_de_core_title = {
    AND = {
        is_title_core_due_to_cti
        will_core_loss_break_titles = no
        }
    }
}