# All scopes are titles unless otherwise noted.

is_title_core_due_to_capital = { # scope is title
    OR = {
            holder.capital_barony = this # capital barony
            AND = {
                holder.capital_barony.target_is_de_jure_liege_or_above = this # de_jure above capital barony
                this.tier < holder.primary_title.tier # not the same tier as the primary title
            }
        }
}

# Assume the default is false/no. Otherwise will need to modify.
is_title_core_due_to_cti = {
    if = {
        limit = {exists = var:core}
        AND = {
            var:core
            NOT = {
                AND = {
                    is_title_core_due_to_capital
                    holder.primary_title = this
                }# I believe that there should be no source always_follows_primary_heir except for during title creation. Titles with this flag cannot be designated core, so they should not have the variable core associated.
            }
        }
    }
}
# MUST BE CAREFUL THAT THE TRIGGERS ABOVE AND BELOW THIS AGREE!
#This catches primary titles and capitals as well (I assume)
# Assume the default is false/no. Otherwise will need to modify.
is_title_core = { # Assume that this will only be called if the title is owned
    if = {
        limit = {exists = var:core}
        OR = {
            var:core
            is_title_core_due_to_capital
            holder.primary_title = this
            always_follows_primary_heir
        }
    }
    else = {
        OR = {
            is_title_core_due_to_capital
            holder.primary_title = this
            always_follows_primary_heir
        }
    }
}

does_core_title_have_cost = { # scope is title
    tier <= tier_county
}
# have both even though they are the same in case I want to break this equivalence in the future.
does_core_title_count_to_limit = { # scope is title
    tier <= tier_county
}

is_title_eligible_for_core = { # Assume that this will only be called if the title is owned
    save_temporary_scope_as = this_title
    AND = {
        NOT = { is_title_core } # not a core title
        OR = {
            tier <= tier_county # county or lower
            holder.any_core_title = { # direct de jure liege of another core title
                this.de_jure_liege = scope:this_title
            }
        }
    }
}

# assumes that core title rules are being followed - only checks one tier up
# ignores capital chain because it should always be intact, and one cannot de-core a title in it.
will_core_loss_break_titles = { # scope is title
    de_jure_liege = {save_temporary_scope_as = parent_title}
    save_temporary_scope_as = this_title
    AND = {
        scope:parent_title.is_title_core # parent title is core
        scope:parent_title.holder = holder # parent title is held by the same character
        NOT = {this.holder.primary_title = scope:parent_title} # parent title is not the holder's primary title
        NOT = {# parent title is not de jure liege of any sibling core titles
            holder.any_core_title = { 
                AND = {
                    NOT = {this = scope:this_title}
                    this.de_jure_liege = scope:parent_title
                }
            }
        }
    }
}


is_core_consistent = {# scope is title
    save_temporary_scope_as = this_title
    OR = {
        tier <= tier_county
        holder.primary_title = this
        is_title_core_due_to_capital
        holder.any_core_title = {
            this.de_jure_liege = scope:this_title
        }
    }
}

# Assume the default is false/no. Otherwise will need to modify.
is_over_core_limit = { # scope is character
    trigger_if = {
        limit = {exists = this.var:core_count}
        this.var:core_count > this.core_limit
        }
}

can_core_title = {
    AND = {
        is_title_eligible_for_core
    }
}

can_de_core_title = {
    AND = {
        is_title_core_due_to_cti
        will_core_loss_break_titles = no
        }
    }
}