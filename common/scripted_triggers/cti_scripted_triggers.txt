# All scopes are titles unless otherwise noted.

is_title_core_due_to_capital = { # scope is title
    OR = {
        holder.capital_county = root # capital barony
        AND = {
            is_de_facto_liege_or_above_target = holder.capital_county
            tier < holder.primary_title.tier # not the same tier as the primary title
        }
    }
}

is_title_special_core = { # Incomplete until I can see the always_follows_primary_heir tag
    is_head_of_faith = yes
}

is_title_core_due_to_not_cti = {
    AND = {
        is_title_core = yes
        OR = {
            is_title_core_due_to_capital = yes
            holder.primary_title = root
            is_title_special_core = yes
        }
    }
}

is_title_core_due_to_cti = {
    AND = {
        is_title_core = yes
        exists = var:core # This condition means that it is technically possible (though it should never happen) that a title is considered neither core due to cti or core due to not cti.
        is_title_core_due_to_not_cti = no
    }
}

is_title_core = { # Assume that this will only be called if the title is owned
    trigger_if = {
        limit = {exists = var:core}
        OR = {
            var:core = yes# var:core should be a boolean
            is_title_core_due_to_capital = yes
            holder.primary_title = root
            is_title_special_core = yes
            tier >= tier_county
        }
    }
    trigger_else = {
        OR = {
            is_title_core_due_to_capital = yes
            holder.primary_title = root
            is_title_special_core = yes
            tier >= tier_county
        }
    }
}

is_title_county = {
    tier = tier_county
}

does_core_count_to_limit = { # scope is title
    is_title_county = yes
}

is_title_eligible_for_core = { # Assume that this will only be called if the title is owned
    is_title_core = no # not a core title
    OR = {
        is_title_county = yes # owned counties can always be dejure
        holder = {# Changes scope to holder
            any_core_title_item = { # direct de facto liege of another core title
            this.de_facto_liege = root
            }
        }
    }
}

# assumes that core title rules are being followed - only checks one tier up
will_core_loss_break_titles = { # scope is title
    AND = {
        root.de_facto_liege = {is_title_core_due_to_cti = yes} # is core due to mod
        NOT = {# parent title is not de facto liege of any sibling core titles
            holder = {
                any_core_title_item = {
                    AND = {
                        NOT = {this = root}
                        this.de_facto_liege = root.de_facto_liege
                    }
                }
            }
        }
    }
}


is_core_consistent = {# scope is title
    OR = {
        is_title_county = yes
        is_title_core_due_to_not_cti= yes
        holder = {
            any_core_title_item = {
                this.de_facto_liege = root
            }
        }
    }
}

is_over_core_limit = { # scope is character
    trigger_if = {
        limit = {exists = var:core_count}
        var:core_count > val_core_limit
    }
    trigger_else = {
        always = no
    }
}

# Different from the trigger contained within in case one wants to add a character restriction on coring titles. There used to be one that characters were not allowed to go over their core limit.
can_core_title = {
    is_title_eligible_for_core = yes
}

can_de_core_title = {
    AND = {
        is_title_core_due_to_cti = yes
        will_core_loss_break_titles = no
    }
}

has_core_titles = { # scope is character
    any_core_title_item = {always = yes} # inefficient, but good enough for now.
}