# All scopes are titles unless otherwise noted.

#This catches primary titles and capitals as well (I assume)
is_title_core = { # Assume that this will only be called if the title is owned
    always_follows_primary_heir = yes
}

is_title_eligible_for_core = { # Assume that this will only be called if the title is owned
    AND = {
        save_temporary_scope_as = this_title
        NOT = { is_title_core }
        OR = {
            tier <= tier_county
            holder.any_core_title = {
                this.de_jure_liege = scope:this_title
            } # this should mean that one of the core titles is a direct child of this title
        }
    }
}

# assumes that core title rules are being followed - only checks one tier up
will_core_loss_break_titles = {
    de_jure_liege = {save_temporary_scope_as = parent_title}
    save_temporary_scope_as = this_title
    OR = {
        scope:parent_title.is_title_core = no
        NOT = {this.holder.primary_title = scope:parent_title} # the primary title breaks the pattern for core titles.
        holder.any_core_title = {
            AND = {
                NOT = {this = scope:this_title}
                this.de_jure_liege = scope:parent_title
            }
        }
    }
}


is_core_consistent = {# scope is title, also fed character
    save_temporary_scope_as = this_title
    OR = {
        tier <= tier_county
        $HOLDER$.primary_title = this
        $HOLDER$.any_core_title = {
            this.de_jure_liege = scope:this_title
        }
    }
}

# Assume the default is false. Otherwise will need to modify.
is_over_core_limit = { # scope is character
    trigger_if = {
        limit = {exists = this.var:core_count}
        this.var:core_count > this.core_limit
        }
}

can_core_title = {
    AND = {
        is_title_eligible_for_core
        holder.is_over_core_limit = no
    }
}

is_title_core_from_capital = {
    OR = {
            holder.capital_barony = this # capital barony
            AND = {
                holder.capital_barony.target_is_de_jure_liege_or_above = this # de_jure above capital barony
                this.tier < holder.primary_title.tier # not the same tier as the primary title
            }
        }
}

can_de_core_title = {
    AND = {
        is_title_core = yes
        will_core_loss_break_titles = no
        NOT = {holder.primary_title = this} # not primary title
        NOT = {# not parent of capital
            is_title_core_from_capital
        }
    }
}